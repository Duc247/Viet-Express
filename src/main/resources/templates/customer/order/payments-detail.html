<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{customer/layout-customer}">

<head>
    <title>Chi tiết thanh toán</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-money-bill-wave me-2"></i>Chi tiết thanh toán</h2>
            <a th:href="@{/customer/orders/{id}(id=${order.id})}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Quay lại
            </a>
        </div>

        <!-- Order Info & Amount Summary -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <span class="text-muted">Đơn hàng:</span>
                        <code class="ms-1" th:text="${order.requestCode}">REQ-XXX</code>
                        <br>
                        <span class="text-muted">Mô tả:</span>
                        <span class="ms-1" th:text="${order.parcelDescription ?: '-'}">Hàng hóa</span>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="row">
                            <div class="col-6">
                                <div class="p-2 bg-primary bg-opacity-10 rounded">
                                    <i class="fas fa-shipping-fast text-primary"></i>
                                    <div class="fw-bold" th:text="${shippingFeeCount}">0</div>
                                    <small class="text-muted">Phí ship</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 bg-info bg-opacity-10 rounded">
                                    <i class="fas fa-hand-holding-usd text-info"></i>
                                    <div class="fw-bold" th:text="${codCount}">0</div>
                                    <small class="text-muted">COD</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div class="mb-1">
                            <span class="text-muted">Tổng:</span>
                            <strong class="text-danger ms-1"
                                th:text="${#numbers.formatDecimal(totalExpected, 0, 'COMMA', 0, 'POINT') + 'đ'}">0đ</strong>
                        </div>
                        <div class="mb-1">
                            <span class="text-muted">Đã trả:</span>
                            <span class="text-success ms-1"
                                th:text="${#numbers.formatDecimal(totalPaid, 0, 'COMMA', 0, 'POINT') + 'đ'}">0đ</span>
                        </div>
                        <div>
                            <span class="text-muted">Còn lại:</span>
                            <strong
                                th:classappend="${remainingAmount.compareTo(T(java.math.BigDecimal).ZERO) == 0 ? 'text-success' : 'text-danger'}"
                                class="ms-1"
                                th:text="${#numbers.formatDecimal(remainingAmount, 0, 'COMMA', 0, 'POINT') + 'đ'}">0đ</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form th:action="@{/customer/orders/{id}/payments(id=${order.id})}" method="get" class="row g-3">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" name="search" placeholder="Tìm theo mã, mô tả..."
                                th:value="${search}">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" name="status">
                            <option value="">-- Trạng thái --</option>
                            <option value="PAID" th:selected="${status == 'PAID'}">Đã thanh toán</option>
                            <option value="UNPAID" th:selected="${status == 'UNPAID'}">Chưa thanh toán</option>
                            <option value="PARTIALLY_PAID" th:selected="${status == 'PARTIALLY_PAID'}">Một phần</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" name="type">
                            <option value="">-- Loại phí --</option>
                            <option value="SHIPPING_FEE" th:selected="${type == 'SHIPPING_FEE'}">Phí ship</option>
                            <option value="COD" th:selected="${type == 'COD'}">COD</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" name="scope">
                            <option value="">-- Phạm vi --</option>
                            <option value="FULL_REQUEST" th:selected="${scope == 'FULL_REQUEST'}">Toàn bộ đơn</option>
                            <option value="PER_TRIP" th:selected="${scope == 'PER_TRIP'}">Theo chuyến</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-filter me-1"></i>Lọc
                        </button>
                    </div>
                </form>
                <div class="mt-2" th:if="${search != null || status != null || type != null}">
                    <a th:href="@{/customer/orders/{id}/payments(id=${order.id})}"
                        class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-times me-1"></i>Xóa bộ lọc
                    </a>
                    <span class="text-muted ms-2" th:text="${'Tìm thấy ' + #lists.size(payments) + ' kết quả'}">0 kết
                        quả</span>
                </div>
            </div>
        </div>

        <!-- Payments List -->
        <div class="card shadow-sm">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 fw-bold text-primary"><i class="fas fa-list me-2"></i>Danh sách khoản thanh toán</h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 4%">#</th>
                                <th style="width: 11%">Mã thanh toán</th>
                                <th style="width: 10%">Loại phí</th>
                                <th style="width: 10%">Cần trả</th>
                                <th style="width: 10%">Đã trả</th>
                                <th style="width: 9%">Trạng thái</th>
                                <th style="width: 14%">Chuyến liên quan</th>
                                <th style="width: 9%">Người trả</th>
                                <th style="width: 9%">Người nhận</th>
                                <th style="width: 10%">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="payment, iterStat : ${payments}">
                                <td th:text="${iterStat.count}">1</td>
                                <td><code th:text="${payment.paymentCode}">PAY-XXX</code></td>
                                <td>
                                    <span th:if="${payment.paymentType.name() == 'SHIPPING_FEE'}"
                                        class="badge bg-primary">
                                        <i class="fas fa-shipping-fast me-1"></i>Ship
                                    </span>
                                    <span th:if="${payment.paymentType.name() == 'COD'}" class="badge bg-info">
                                        <i class="fas fa-hand-holding-usd me-1"></i>COD
                                    </span>
                                </td>
                                <td>
                                    <strong
                                        th:text="${#numbers.formatDecimal(payment.expectedAmount, 0, 'COMMA', 0, 'POINT') + 'đ'}">0đ</strong>
                                </td>
                                <td>
                                    <span
                                        th:text="${#numbers.formatDecimal(payment.paidAmount, 0, 'COMMA', 0, 'POINT') + 'đ'}"
                                        th:classappend="${payment.paidAmount.compareTo(payment.expectedAmount) >= 0 ? 'text-success' : 'text-warning'}">0đ</span>
                                </td>
                                <td>
                                    <span class="badge bg-success" th:if="${payment.status.name() == 'PAID'}">Đã
                                        TT</span>
                                    <span class="badge bg-warning text-dark"
                                        th:if="${payment.status.name() == 'UNPAID'}">Chưa TT</span>
                                    <span class="badge bg-info" th:if="${payment.status.name() == 'PARTIALLY_PAID'}">Một
                                        phần</span>
                                </td>
                                <td>
                                    <!-- Hiển thị phạm vi thanh toán và trip info -->
                                    <div
                                        th:if="${payment.paymentScope != null && payment.paymentScope.name() == 'FULL_REQUEST'}">
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-box me-1"></i>Toàn bộ đơn
                                        </span>
                                        <br>
                                        <small class="text-muted" th:text="${order.requestCode}">REQ-XXX</small>
                                    </div>
                                    <div
                                        th:if="${payment.paymentScope != null && payment.paymentScope.name() == 'PER_TRIP'}">
                                        <span class="badge bg-purple" style="background-color: #6f42c1!important;">
                                            <i class="fas fa-truck me-1"></i>Theo chuyến
                                        </span>
                                        <div th:if="${payment.trip != null}">
                                            <span class="badge bg-info mt-1"
                                                th:if="${payment.trip.tripType.name() == 'PICKUP'}">Lấy hàng</span>
                                            <span class="badge bg-primary mt-1"
                                                th:if="${payment.trip.tripType.name() == 'TRANSFER'}">Trung
                                                chuyển</span>
                                            <span class="badge bg-success mt-1"
                                                th:if="${payment.trip.tripType.name() == 'DELIVERY'}">Giao hàng</span>
                                            <span class="badge bg-warning text-dark mt-1"
                                                th:if="${payment.trip.tripType.name() == 'RETURN'}">Hoàn</span>
                                            <br>
                                            <small class="text-muted" th:text="${'Trip #' + payment.trip.id}">Trip
                                                #X</small>
                                        </div>
                                        <small th:if="${payment.trip == null}" class="text-muted">Chưa gắn trip</small>
                                    </div>
                                    <small th:if="${payment.paymentScope == null}" class="text-muted">-</small>
                                </td>
                                <td>
                                    <small th:if="${payment.payerType != null}">
                                        <span th:if="${payment.payerType.name() == 'SENDER'}">Người gửi</span>
                                        <span th:if="${payment.payerType.name() == 'RECEIVER'}">Người nhận</span>
                                        <span th:if="${payment.payerType.name() == 'COMPANY'}">Công ty</span>
                                    </small>
                                    <small th:unless="${payment.payerType != null}" class="text-muted">-</small>
                                </td>
                                <td>
                                    <small th:if="${payment.receiverType != null}">
                                        <span th:if="${payment.receiverType.name() == 'SENDER'}">Người gửi</span>
                                        <span th:if="${payment.receiverType.name() == 'RECEIVER'}">Người nhận</span>
                                        <span th:if="${payment.receiverType.name() == 'COMPANY'}">Công ty</span>
                                    </small>
                                    <small th:unless="${payment.receiverType != null}" class="text-muted">-</small>
                                </td>
                                <td>
                                    <!-- Nút thanh toán chỉ hiện khi chưa thanh toán đủ -->
                                    <button th:if="${payment.status.name() != 'PAID'}" type="button"
                                        class="btn btn-sm btn-success btn-pay" th:attr="data-payment-code=${payment.paymentCode},
                                                     data-payment-id=${payment.id},
                                                     data-amount=${payment.expectedAmount.subtract(payment.paidAmount)},
                                                     data-description=${payment.paymentType.name() == 'SHIPPING_FEE' ? 'Phí vận chuyển' : 'Thu hộ COD'},
                                                     data-order-code=${order.requestCode}">
                                        <i class="fas fa-qrcode me-1"></i>Thanh toán
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-info btn-history ms-1"
                                        th:attr="data-payment-id=${payment.id}, data-payment-code=${payment.paymentCode}">
                                        <i class="fas fa-history me-1"></i>Lịch sử
                                    </button>
                                    <span th:if="${payment.status.name() == 'PAID'}" class="text-success">
                                        <i class="fas fa-check-circle"></i>
                                    </span>
                                </td>
                            </tr>
                            <!-- Description row -->
                            <tr th:each="payment : ${payments}" th:if="${payment.description}" class="table-light">
                                <td></td>
                                <td colspan="9" class="py-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <span th:text="${payment.description}">Mô tả thanh toán...</span>
                                    </small>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(payments)}">
                                <td colspan="9" class="text-center text-muted py-4">
                                    <i class="fas fa-money-bill-wave fa-2x mb-2 d-block opacity-50"></i>
                                    Không tìm thấy khoản thanh toán nào
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Payment Status Summary -->
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <h3 class="text-success" th:text="${paidPayments}">0</h3>
                        <small class="text-muted">Đã thanh toán</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <h3 class="text-info" th:text="${partiallyPaidPayments}">0</h3>
                        <small class="text-muted">Thanh toán một phần</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <h3 class="text-warning" th:text="${unpaidPayments}">0</h3>
                        <small class="text-muted">Chưa thanh toán</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- VNPay Payment Modal (inside content fragment) -->
        <div class="modal fade" id="vnpayModal" tabindex="-1" aria-labelledby="vnpayModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <!-- VNPay Header -->
                    <div class="modal-header text-white"
                        style="background: linear-gradient(135deg, #005baa 0%, #00a0e4 100%);">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-university fa-2x"></i>
                            </div>
                            <div>
                                <h5 class="modal-title mb-0" id="vnpayModalLabel">
                                    <strong>VNPAY</strong> - Thanh toán QR
                                </h5>
                                <small>Quét mã để thanh toán</small>
                            </div>
                        </div>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>

                    <div class="modal-body">
                        <!-- Invoice Info -->
                        <div class="bg-light rounded p-3 mb-3">
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">Mã giao dịch:</small>
                                    <div class="fw-bold" id="vnpay-txn-code">VNP-XXXXXX</div>
                                </div>
                                <div class="col-6 text-end">
                                    <small class="text-muted">Thời gian:</small>
                                    <div class="fw-bold" id="vnpay-time">--:--</div>
                                </div>
                            </div>
                            <hr class="my-2">
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">Đơn hàng:</small>
                                    <div class="fw-bold" id="vnpay-order-code">REQ-XXX</div>
                                </div>
                                <div class="col-6 text-end">
                                    <small class="text-muted">Mã thanh toán:</small>
                                    <div class="fw-bold" id="vnpay-payment-code">PAY-XXX</div>
                                </div>
                            </div>
                        </div>

                        <!-- QR Code -->
                        <div class="text-center mb-3">
                            <div class="border rounded p-3 d-inline-block bg-white"
                                style="box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                                <div id="vnpay-qrcode"
                                    style="width: 200px; height: 200px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-mobile-alt me-1"></i>
                                    Mở app ngân hàng và quét mã QR
                                </small>
                            </div>
                        </div>

                        <!-- Amount -->
                        <div class="alert alert-primary text-center mb-3">
                            <small class="text-muted">Số tiền thanh toán</small>
                            <div class="display-6 fw-bold text-primary" id="vnpay-amount">0 VND</div>
                            <small id="vnpay-description">Phí vận chuyển</small>
                        </div>

                        <!-- Bank info -->
                        <div class="border rounded p-3">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    <div class="bg-primary text-white rounded p-2">
                                        <i class="fas fa-university fa-lg"></i>
                                    </div>
                                </div>
                                <div class="col">
                                    <small class="text-muted">Chuyển khoản đến</small>
                                    <div class="fw-bold">VIET EXPRESS LOGISTICS</div>
                                    <div class="text-muted">
                                        <small>STK: 1234567890 - Vietcombank</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Countdown timer -->
                        <div class="text-center mt-3">
                            <small class="text-muted">Giao dịch hết hạn sau: </small>
                            <span class="badge bg-warning text-dark" id="vnpay-countdown">15:00</span>
                        </div>
                    </div>

                    <div class="modal-footer justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Đóng
                        </button>
                        <button type="button" class="btn btn-success" id="btn-simulate-success">
                            <i class="fas fa-check me-1"></i>Mô phỏng thanh toán thành công
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Success Modal -->
        <div class="modal fade" id="paymentSuccessModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-sm">
                <div class="modal-content text-center">
                    <div class="modal-body py-5">
                        <div class="text-success mb-3">
                            <i class="fas fa-check-circle fa-5x"></i>
                        </div>
                        <h4 class="text-success">Thanh toán thành công!</h4>
                        <p class="text-muted mb-0">Giao dịch đã được xử lý</p>
                        <p class="fw-bold" id="success-amount">0 VND</p>
                    </div>
                    <div class="modal-footer justify-content-center border-0">
                        <button type="button" class="btn btn-success" id="btn-reload">
                            <i class="fas fa-sync-alt me-1"></i>Làm mới trang
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction History Modal -->
        <div class="modal fade" id="transactionHistoryModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-history me-2"></i>Lịch sử giao dịch: <span id="history-payment-code"
                                class="fw-bold">...</span>
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-6 ms-auto">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" id="transaction-search" class="form-control"
                                        placeholder="Tìm theo mã tham chiếu...">
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Loại</th>
                                        <th>Phương thức</th>
                                        <th>Mã tham chiếu</th>
                                        <th class="text-end">Số tiền</th>
                                        <th>Thời gian</th>
                                        <th>Trạng thái</th>
                                    </tr>
                                </thead>
                                <tbody id="transaction-history-body">
                                    <tr>
                                        <td colspan="7" class="text-center py-4">Đang tải dữ liệu...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    </div>
                </div>
            </div>
        </div>

        <style>
            #vnpay-qrcode canvas {
                display: block !important;
            }

            .modal-header .btn-close-white {
                filter: invert(1) grayscale(100%) brightness(200%);
            }
        </style>
    </div>

    <!-- JavaScript Fragment -->
    <th:block layout:fragment="js">
        <!-- QR Code Generator Library - using a different CDN -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

        <script>
            (function () {
                let vnpayModal;
                let successModal;
                let transactionModal;
                let countdownInterval;
                let currentPaymentId;
                let historyPaymentId;

                // Wait for DOM to be ready
                document.addEventListener('DOMContentLoaded', function () {
                    console.log('Payment page loaded');

                    // Initialize modals
                    const vnpayModalEl = document.getElementById('vnpayModal');
                    const successModalEl = document.getElementById('paymentSuccessModal');

                    if (vnpayModalEl) {
                        vnpayModal = new bootstrap.Modal(vnpayModalEl);
                    }
                    if (successModalEl) {
                        successModal = new bootstrap.Modal(successModalEl);
                    }
                    const transactionModalEl = document.getElementById('transactionHistoryModal');
                    if (transactionModalEl) {
                        transactionModal = new bootstrap.Modal(transactionModalEl);
                    }

                    // Attach click handlers to all pay buttons
                    document.querySelectorAll('.btn-pay').forEach(function (btn) {
                        btn.addEventListener('click', function () {
                            showVNPayModal(this);
                        });
                    });

                    // Simulate success button
                    const btnSuccess = document.getElementById('btn-simulate-success');
                    if (btnSuccess) {
                        btnSuccess.addEventListener('click', simulatePaymentSuccess);
                    }

                    // Reload button
                    const btnReload = document.getElementById('btn-reload');
                    if (btnReload) {
                        btnReload.addEventListener('click', function () {
                            location.reload();
                        });
                    }

                    // Clean up countdown when modal closes
                    if (vnpayModalEl) {
                        vnpayModalEl.addEventListener('hidden.bs.modal', function () {
                            if (countdownInterval) {
                                clearInterval(countdownInterval);
                            }
                        });
                    }

                    // Attach click handlers to all history buttons
                    document.querySelectorAll('.btn-history').forEach(function (btn) {
                        btn.addEventListener('click', function () {
                            const paymentId = this.getAttribute('data-payment-id');
                            const paymentCode = this.getAttribute('data-payment-code');
                            showTransactionHistory(paymentId, paymentCode);
                        });
                    });

                    // Search delay for transactions
                    const searchInput = document.getElementById('transaction-search');
                    if (searchInput) {
                        searchInput.addEventListener('input', debounce(function () {
                            loadTransactions(historyPaymentId, this.value);
                        }, 300));
                    }
                });

                function showVNPayModal(button) {
                    console.log('Opening VNPay modal');

                    const paymentCode = button.getAttribute('data-payment-code');
                    const paymentId = button.getAttribute('data-payment-id');
                    const amount = parseFloat(button.getAttribute('data-amount'));
                    const description = button.getAttribute('data-description');
                    const orderCode = button.getAttribute('data-order-code');

                    currentPaymentId = paymentId;

                    // Generate transaction code
                    const txnCode = 'VNP' + Date.now().toString().slice(-8);

                    // Current time
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                    const dateStr = now.toLocaleDateString('vi-VN');

                    // Update modal content
                    document.getElementById('vnpay-txn-code').textContent = txnCode;
                    document.getElementById('vnpay-time').textContent = timeStr + ' ' + dateStr;
                    document.getElementById('vnpay-order-code').textContent = orderCode;
                    document.getElementById('vnpay-payment-code').textContent = paymentCode;
                    document.getElementById('vnpay-amount').textContent = formatCurrency(amount) + ' VND';
                    document.getElementById('vnpay-description').textContent = description;

                    // Generate QR Code
                    const qrContainer = document.getElementById('vnpay-qrcode');
                    qrContainer.innerHTML = ''; // Clear previous QR

                    // QR content simulating VNPay payment URL
                    const qrContent = 'vnpay://pay?txn=' + txnCode + '&amount=' + amount + '&order=' + orderCode;

                    try {
                        new QRCode(qrContainer, {
                            text: qrContent,
                            width: 200,
                            height: 200,
                            colorDark: '#005baa',
                            colorLight: '#ffffff',
                            correctLevel: QRCode.CorrectLevel.H
                        });
                        console.log('QR Code generated');
                    } catch (e) {
                        console.error('QR Code error:', e);
                        qrContainer.innerHTML = '<div class="text-center p-4"><i class="fas fa-qrcode fa-4x text-primary"></i><br><small class="text-muted">QR Code</small></div>';
                    }

                    // Start countdown timer (15 minutes)
                    startCountdown(15 * 60);

                    // Show modal
                    if (vnpayModal) {
                        vnpayModal.show();
                    }
                }

                function formatCurrency(amount) {
                    return new Intl.NumberFormat('vi-VN').format(amount);
                }

                function startCountdown(seconds) {
                    // Clear previous interval
                    if (countdownInterval) {
                        clearInterval(countdownInterval);
                    }

                    const countdownEl = document.getElementById('vnpay-countdown');

                    countdownInterval = setInterval(function () {
                        const minutes = Math.floor(seconds / 60);
                        const secs = seconds % 60;
                        countdownEl.textContent = minutes.toString().padStart(2, '0') + ':' + secs.toString().padStart(2, '0');

                        if (seconds <= 60) {
                            countdownEl.classList.remove('bg-warning', 'text-dark');
                            countdownEl.classList.add('bg-danger', 'text-white');
                        }

                        if (seconds <= 0) {
                            clearInterval(countdownInterval);
                            countdownEl.textContent = 'Hết hạn';
                        }

                        seconds--;
                    }, 1000);
                }

                function simulatePaymentSuccess() {
                    console.log('Simulating payment success for payment ID:', currentPaymentId);

                    // Disable button while processing
                    const btnSimulate = document.getElementById('btn-simulate-success');
                    if (btnSimulate) {
                        btnSimulate.disabled = true;
                        btnSimulate.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang xử lý...';
                    }

                    // Call API to update payment status
                    fetch('/customer/api/payments/' + currentPaymentId + '/simulate-pay', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                        .then(function (response) {
                            return response.json();
                        })
                        .then(function (data) {
                            console.log('API Response:', data);

                            // Hide VNPay modal
                            if (vnpayModal) {
                                vnpayModal.hide();
                            }
                            if (countdownInterval) {
                                clearInterval(countdownInterval);
                            }

                            if (data.success) {
                                // Show success modal
                                const amount = document.getElementById('vnpay-amount').textContent;
                                document.getElementById('success-amount').textContent = amount;

                                if (successModal) {
                                    successModal.show();
                                }
                            } else {
                                alert('Lỗi: ' + data.message);
                                // Re-enable button
                                if (btnSimulate) {
                                    btnSimulate.disabled = false;
                                    btnSimulate.innerHTML = '<i class="fas fa-check me-1"></i>Mô phỏng thanh toán thành công';
                                }
                            }
                        })
                        .catch(function (error) {
                            console.error('Error:', error);
                            alert('Lỗi kết nối! Vui lòng thử lại.');
                            // Re-enable button
                            if (btnSimulate) {
                                btnSimulate.disabled = false;
                                btnSimulate.innerHTML = '<i class="fas fa-check me-1"></i>Mô phỏng thanh toán thành công';
                            }
                        });
                }

                function showTransactionHistory(paymentId, paymentCode) {
                    historyPaymentId = paymentId;
                    document.getElementById('history-payment-code').textContent = paymentCode;
                    document.getElementById('transaction-search').value = '';
                    loadTransactions(paymentId);
                    if (transactionModal) {
                        transactionModal.show();
                    }
                }

                function loadTransactions(paymentId, search = '') {
                    const tbody = document.getElementById('transaction-history-body');
                    if (!tbody) return;

                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4"><div class="spinner-border spinner-border-sm text-primary"></div> Đang tải...</td></tr>';

                    let url = `/customer/payments/${paymentId}/transactions`;
                    if (search) url += `?search=${encodeURIComponent(search)}`;

                    fetch(url)
                        .then(res => res.json())
                        .then(data => {
                            if (data.length === 0) {
                                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">Không có giao dịch nào khớp với tìm kiếm.</td></tr>';
                                return;
                            }

                            tbody.innerHTML = data.map((txn, index) => {
                                const badgeClass = txn.status === 'SUCCESS' ? 'bg-success' : (txn.status === 'FAILED' ? 'bg-danger' : 'bg-warning text-dark');
                                const typeLabel = txn.type === 'IN' ? 'Thu' : 'Chi';
                                const typeClass = txn.type === 'IN' ? 'text-success' : 'text-danger';

                                return `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td class="${typeClass} fw-bold">${typeLabel}</td>
                                        <td><small>${txn.method}</small></td>
                                        <td><code>${txn.ref || '-'}</code></td>
                                        <td class="text-end fw-bold">${new Intl.NumberFormat('vi-VN').format(txn.amount)}đ</td>
                                        <td><small>${txn.time ? txn.time.replace('T', ' ').substring(0, 19) : '-'}</small></td>
                                        <td><span class="badge ${badgeClass}">${txn.status}</span></td>
                                    </tr>
                                `;
                            }).join('');
                        })
                        .catch(err => {
                            console.error(err);
                            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-danger">Lỗi khi tải dữ liệu!</td></tr>';
                        });
                }

                function debounce(func, wait) {
                    let timeout;
                    return function () {
                        const context = this, args = arguments;
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(context, args), wait);
                    };
                }

                // Make functions global if needed
                window.showVNPayModal = showVNPayModal;
                window.simulatePaymentSuccess = simulatePaymentSuccess;
                window.showTransactionHistory = showTransactionHistory;
            })();
        </script>
    </th:block>
</body>

</html>