<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{manager/layout-manager}">

<head>
    <title>X·∫øp H√†ng L√™n Xe - Manager</title>
</head>

<body>

    <div layout:fragment="content">

        <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2"><i class="fas fa-truck-loading me-2"></i>X·∫øp h√†ng l√™n xe</h1>
            <a th:href="@{/manager/trips}" class="btn btn-outline-secondary">
                <i class="fas fa-list me-1"></i>Danh s√°ch chuy·∫øn
            </a>
        </div>

        <!-- Alert Messages -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show">
            <i class="fas fa-check-circle me-2"></i><span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show">
            <i class="fas fa-exclamation-circle me-2"></i><span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="row">
            <!-- C·ªôt tr√°i: Ch·ªçn chuy·∫øn v√† ki·ªán ch·ªù x·∫øp -->
            <div class="col-lg-7">
                <!-- Ch·ªçn chuy·∫øn -->
                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-primary text-white py-2">
                        <h6 class="m-0 fw-bold"><i class="fas fa-truck me-2"></i>Ch·ªçn chuy·∫øn</h6>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/manager/trip-planning}" method="get" class="d-flex gap-2">
                            <select name="tripId" class="form-select" onchange="this.form.submit()">
                                <option value="">-- Ch·ªçn chuy·∫øn ƒë·ªÉ x·∫øp h√†ng --</option>
                                <option th:each="t : ${availableTrips}" th:value="${t.id}"
                                    th:selected="${selectedTrip != null && selectedTrip.id == t.id}"
                                    th:text="'#' + ${t.id} + ' - ' + ${t.tripType.name()} + ' (' + ${t.startLocation?.name ?: '?'} + ' ‚Üí ' + ${t.endLocation?.name ?: '?'} + ')'">
                                    Chuy·∫øn
                                </option>
                            </select>
                        </form>
                        <div th:if="${#lists.isEmpty(availableTrips)}" class="mt-2">
                            <span class="text-muted">Kh√¥ng c√≥ chuy·∫øn n√†o ƒëang ch·ªù. T·∫°o chuy·∫øn m·ªõi t·ª´ chi ti·∫øt ƒë∆°n
                                h√†ng.</span>
                        </div>
                    </div>
                </div>

                <!-- Danh s√°ch ki·ªán ch·ªù x·∫øp -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 fw-bold text-primary"><i class="fas fa-boxes me-2"></i>Ki·ªán h√†ng ch·ªù x·∫øp</h6>
                        <span class="badge bg-secondary" th:text="${#lists.size(unassignedParcels)} + ' ki·ªán'">0
                            ki·ªán</span>
                    </div>

                    <form th:action="@{/manager/trip-planning/load-parcels}" method="post"
                        th:if="${selectedTrip != null}">
                        <input type="hidden" name="tripId" th:value="${selectedTrip.id}">
                        <div class="bg-light p-2 border-bottom d-flex justify-content-between align-items-center">
                            <span class="text-muted small">Ch·ªçn ki·ªán v√† nh·∫•n "X·∫øp l√™n xe"</span>
                            <button type="submit" class="btn btn-sm btn-success fw-bold"
                                th:disabled="${selectedTrip.capacityStatus?.name() == 'FULL'}">
                                <i class="fas fa-arrow-up me-1"></i>X·∫øp l√™n xe
                            </button>
                        </div>

                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-hover table-sm mb-0 align-middle">
                                    <thead class="bg-light sticky-top">
                                        <tr>
                                            <th class="text-center" style="width: 40px;"><input type="checkbox"
                                                    id="selectAllUnassigned"></th>
                                            <th>M√£ ki·ªán</th>
                                            <th>M√¥ t·∫£</th>
                                            <th>Tr·∫°ng th√°i</th>
                                            <th>ƒê∆°n h√†ng</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:if="${#lists.isEmpty(unassignedParcels)}" class="text-muted text-center">
                                            <td colspan="5" class="py-4">
                                                <i class="fas fa-check-circle fa-2x mb-2 text-success d-block"></i>
                                                Kh√¥ng c√≥ ki·ªán n√†o ch·ªù x·∫øp
                                            </td>
                                        </tr>
                                        <tr th:each="p : ${unassignedParcels}">
                                            <td class="text-center">
                                                <input type="checkbox" name="parcelIds" th:value="${p.id}"
                                                    class="unassigned-checkbox">
                                            </td>
                                            <td><code class="text-primary fw-bold"
                                                    th:text="${p.parcelCode}">PCL-XXX</code></td>
                                            <td th:text="${#strings.abbreviate(p.description ?: '-', 25)}">M√¥ t·∫£</td>
                                            <td>
                                                <span class="badge bg-secondary"
                                                    th:if="${p.status.name() == 'CREATED'}">M·ªõi</span>
                                                <span class="badge bg-warning text-dark"
                                                    th:if="${p.status.name() == 'PICKED_UP'}">ƒê√£ l·∫•y</span>
                                                <span class="badge bg-info"
                                                    th:if="${p.status.name() == 'IN_WAREHOUSE'}">Trong kho</span>
                                            </td>
                                            <td><small th:text="${p.request?.requestCode ?: '-'}">REQ-XXX</small></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </form>
                    <div class="card-body text-center text-muted py-4" th:if="${selectedTrip == null}">
                        <i class="fas fa-hand-point-up fa-2x mb-2 opacity-50"></i>
                        <p class="mb-0">Vui l√≤ng ch·ªçn chuy·∫øn ƒë·ªÉ x·∫øp h√†ng</p>
                    </div>
                </div>
            </div>

            <!-- C·ªôt ph·∫£i: Chi ti·∫øt chuy·∫øn ƒë√£ ch·ªçn -->
            <div class="col-lg-5">
                <!-- Chi ti·∫øt chuy·∫øn -->
                <div th:if="${selectedTrip != null}" class="card shadow-sm mb-3">
                    <div
                        class="card-header bg-success text-white py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 fw-bold"><i class="fas fa-truck-moving me-2"></i>Chuy·∫øn #<span
                                th:text="${selectedTrip.id}">1</span></h6>
                        <div>
                            <span class="badge bg-light text-dark"
                                th:text="${selectedTrip.tripType.name()}">PICKUP</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-6">
                                <small class="text-muted">T·ª´:</small>
                                <div th:text="${selectedTrip.startLocation?.name ?: '-'}">Kho A</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">ƒê·∫øn:</small>
                                <div th:text="${selectedTrip.endLocation?.name ?: '-'}">Kho B</div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">T√†i x·∫ø:</small>
                            <div th:text="${selectedTrip.shipper?.fullName ?: 'Ch∆∞a g√°n'}">T√†i x·∫ø A</div>
                        </div>

                        <!-- Tr·∫°ng th√°i xe -->
                        <div class="border-top pt-3 mt-3">
                            <label class="form-label fw-bold">Tr·∫°ng th√°i xe:</label>
                            <form th:action="@{/manager/trips/{id}/update-capacity(id=${selectedTrip.id})}"
                                method="post" class="d-flex gap-2">
                                <select name="capacityStatus" class="form-select form-select-sm">
                                    <option value="EMPTY"
                                        th:selected="${selectedTrip.capacityStatus?.name() == 'EMPTY'}">üü¢ Tr·ªëng
                                    </option>
                                    <option value="AVAILABLE"
                                        th:selected="${selectedTrip.capacityStatus?.name() == 'AVAILABLE'}">üü° C√≤n ch·ªó
                                    </option>
                                    <option value="FULL" th:selected="${selectedTrip.capacityStatus?.name() == 'FULL'}">
                                        üî¥ ƒê√£ ƒë·∫ßy</option>
                                </select>
                                <button type="submit" class="btn btn-sm btn-outline-primary">C·∫≠p nh·∫≠t</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- H√†ng ƒë√£ x·∫øp l√™n xe -->
                <div th:if="${selectedTrip != null}" class="card shadow-sm">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 fw-bold text-success"><i class="fas fa-box-open me-2"></i>H√†ng ƒë√£ x·∫øp</h6>
                        <span class="badge bg-success" th:text="${#lists.size(loadedParcels)} + ' ki·ªán'">0 ki·ªán</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm mb-0 align-middle">
                                <thead class="bg-light sticky-top">
                                    <tr>
                                        <th class="ps-3">M√£ ki·ªán</th>
                                        <th>M√¥ t·∫£</th>
                                        <th class="text-end pe-3">H√†nh ƒë·ªông</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:if="${#lists.isEmpty(loadedParcels)}" class="text-center text-muted">
                                        <td colspan="3" class="py-4">
                                            <i class="fas fa-inbox fa-2x mb-2 opacity-50 d-block"></i>
                                            Ch∆∞a c√≥ h√†ng tr√™n xe
                                        </td>
                                    </tr>
                                    <tr th:each="p : ${loadedParcels}">
                                        <td class="ps-3"><code class="text-success fw-bold"
                                                th:text="${p.parcelCode}">PCL-XXX</code></td>
                                        <td th:text="${#strings.abbreviate(p.description ?: '-', 20)}">M√¥ t·∫£</td>
                                        <td class="text-end pe-3">
                                            <form th:action="@{/manager/trip-planning/unload-parcel}" method="post"
                                                class="d-inline">
                                                <input type="hidden" name="parcelId" th:value="${p.id}">
                                                <input type="hidden" name="tripId" th:value="${selectedTrip.id}">
                                                <button type="submit" class="btn btn-sm btn-outline-danger"
                                                    title="D·ª° kh·ªèi xe"
                                                    onclick="return confirm('D·ª° ki·ªán n√†y kh·ªèi xe?');">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Placeholder khi ch∆∞a ch·ªçn chuy·∫øn -->
                <div th:if="${selectedTrip == null}" class="alert alert-light border text-center py-5">
                    <i class="fas fa-calendar-plus fa-3x mb-3 text-muted"></i>
                    <h5 class="text-muted">Ch∆∞a ch·ªçn chuy·∫øn</h5>
                    <p class="mb-0 text-muted">Ch·ªçn chuy·∫øn t·ª´ danh s√°ch b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu x·∫øp h√†ng</p>
                </div>
            </div>
        </div>

        <script>
            document.getElementById('selectAllUnassigned')?.addEventListener('change', function () {
                document.querySelectorAll('.unassigned-checkbox').forEach(cb => cb.checked = this.checked);
            });
        </script>

    </div>
</body>

</html>