<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{manager/layout-manager}">

<head>
    <title>Thanh to√°n - Request</title>
</head>

<body>

    <div layout:fragment="content">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="h4 fw-bold mb-1"><i class="fas fa-money-bill me-2"></i>Thanh to√°n</h2>
                <span class="text-muted">ƒê∆°n: </span>
                <a th:href="@{/manager/requests/{id}(id=${order.id})}" th:text="${order.requestCode}">REQ-XXX</a>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createPaymentModal">
                    <i class="fas fa-plus me-1"></i>T·∫°o m·ªõi
                </button>
                <a th:href="@{/manager/requests/{id}(id=${order.id})}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Quay l·∫°i
                </a>
            </div>
        </div>

        <!-- Search Form -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form th:action="@{/manager/requests/{id}/payments(id=${order.id})}" method="get" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">T√¨m ki·∫øm</label>
                        <input type="text" name="keyword" class="form-control" placeholder="M√£, m√¥ t·∫£..."
                            th:value="${keyword}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Lo·∫°i</label>
                        <select name="type" class="form-select">
                            <option value="">-- T·∫•t c·∫£ --</option>
                            <option value="SHIPPING_FEE" th:selected="${type == 'SHIPPING_FEE'}">Ph√≠ ship</option>
                            <option value="COD" th:selected="${type == 'COD'}">COD</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Tr·∫°ng th√°i</label>
                        <select name="status" class="form-select">
                            <option value="">-- T·∫•t c·∫£ --</option>
                            <option value="UNPAID" th:selected="${status == 'UNPAID'}">Ch∆∞a TT</option>
                            <option value="PARTIALLY_PAID" th:selected="${status == 'PARTIALLY_PAID'}">ƒê√£ c·ªçc</option>
                            <option value="PAID" th:selected="${status == 'PAID'}">ƒê√£ TT</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end gap-2">
                        <button type="submit" class="btn btn-primary flex-fill"><i class="fas fa-search"></i></button>
                        <a th:href="@{/manager/requests/{id}/payments(id=${order.id})}"
                            class="btn btn-outline-secondary"><i class="fas fa-redo"></i></a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Results Table -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 fw-bold text-success">Danh s√°ch thanh to√°n</h6>
                <span class="badge bg-success" th:text="${paymentsPage.totalItems} + ' kho·∫£n'">0 kho·∫£n</span>
            </div>
            <div class="card-body px-0 pt-0 pb-2">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">M√£</th>
                                <th>Lo·∫°i</th>
                                <th>S·ªë ti·ªÅn</th>
                                <th>ƒê√£ TT</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>M√¥ t·∫£</th>
                                <th class="text-end pe-4">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:if="${#lists.isEmpty(paymentsPage.content)}" class="text-center text-muted">
                                <td colspan="7" class="py-4">Kh√¥ng t√¨m th·∫•y kho·∫£n thanh to√°n</td>
                            </tr>
                            <tr th:each="p : ${paymentsPage.content}">
                                <td class="ps-4"><code th:text="${p.paymentCode ?: '-'}">PAY-XXX</code></td>
                                <td>
                                    <span class="badge bg-primary" th:if="${p.paymentType.name() == 'SHIPPING_FEE'}">Ph√≠
                                        ship</span>
                                    <span class="badge bg-warning text-dark"
                                        th:if="${p.paymentType.name() == 'COD'}">COD</span>
                                </td>
                                <td class="fw-bold"
                                    th:text="${#numbers.formatDecimal(p.expectedAmount ?: 0, 0, 'COMMA', 0, 'POINT')} + '‚Ç´'">
                                    0‚Ç´</td>
                                <td
                                    th:text="${#numbers.formatDecimal(p.paidAmount ?: 0, 0, 'COMMA', 0, 'POINT')} + '‚Ç´'">
                                    0‚Ç´</td>
                                <td>
                                    <span class="badge bg-danger" th:if="${p.status.name() == 'UNPAID'}">Ch∆∞a TT</span>
                                    <span class="badge bg-warning text-dark"
                                        th:if="${p.status.name() == 'PARTIALLY_PAID'}">ƒê√£ c·ªçc</span>
                                    <span class="badge bg-success" th:if="${p.status.name() == 'PAID'}">ƒê√£ TT</span>
                                </td>
                                <td th:text="${#strings.abbreviate(p.description ?: '-', 20)}">M√¥ t·∫£</td>
                                <td class="text-end pe-4">
                                    <a th:href="@{/manager/payments/{pid}(pid=${p.id})}"
                                        class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Pagination -->
            <div class="card-footer" th:if="${paymentsPage.totalPages > 1}">
                <nav>
                    <ul class="pagination pagination-sm mb-0 justify-content-center">
                        <li class="page-item" th:classappend="${!paymentsPage.hasPrevious ? 'disabled' : ''}">
                            <a class="page-link"
                                th:href="@{/manager/requests/{id}/payments(id=${order.id}, page=${paymentsPage.currentPage - 1}, keyword=${keyword}, status=${status}, type=${type})}">¬´</a>
                        </li>
                        <li th:each="i : ${#numbers.sequence(1, paymentsPage.totalPages)}" class="page-item"
                            th:classappend="${i == paymentsPage.currentPage ? 'active' : ''}">
                            <a class="page-link"
                                th:href="@{/manager/requests/{id}/payments(id=${order.id}, page=${i}, keyword=${keyword}, status=${status}, type=${type})}"
                                th:text="${i}">1</a>
                        </li>
                        <li class="page-item" th:classappend="${!paymentsPage.hasNext ? 'disabled' : ''}">
                            <a class="page-link"
                                th:href="@{/manager/requests/{id}/payments(id=${order.id}, page=${paymentsPage.currentPage + 1}, keyword=${keyword}, status=${status}, type=${type})}">¬ª</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>

        <!-- Modal: T·∫°o Payment -->
        <div class="modal fade" id="createPaymentModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title"><i class="fas fa-money-bill me-2"></i>T·∫°o Payment</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <form th:action="@{/manager/payments/create}" method="post">
                        <div class="modal-body">
                            <input type="hidden" name="requestId" th:value="${order.id}">

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Lo·∫°i kho·∫£n ti·ªÅn</label>
                                    <select name="paymentType" class="form-select" required>
                                        <option value="SHIPPING_FEE">üíµ Ph√≠ v·∫≠n chuy·ªÉn</option>
                                        <option value="COD">üì¶ Thu h·ªô COD</option>
                                        <option value="DEPOSIT">üí∞ Ti·ªÅn c·ªçc</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">S·ªë ti·ªÅn (VNƒê)</label>
                                    <input type="number" name="expectedAmount" class="form-control" required min="0"
                                        placeholder="500000">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Ph·∫°m vi thanh to√°n</label>
                                    <select name="paymentScope" class="form-select" required>
                                        <option value="FULL_REQUEST">üìã To√†n b·ªô ƒë∆°n h√†ng</option>
                                        <option value="PER_TRIP">üöö Theo chuy·∫øn v·∫≠n chuy·ªÉn</option>
                                    </select>
                                    <small class="text-muted">Ch·ªçn chuy·∫øn trong trang chi ti·∫øt ƒë∆°n</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Ng∆∞·ªùi tr·∫£ ti·ªÅn</label>
                                    <select name="payerType" class="form-select" required>
                                        <option value="SENDER">üë§ Ng∆∞·ªùi g·ª≠i</option>
                                        <option value="RECEIVER">üì¨ Ng∆∞·ªùi nh·∫≠n</option>
                                        <option value="COMPANY">üè¢ C√¥ng ty</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Nh·∫≠n ti·ªÅn</label>
                                    <select name="receiverType" class="form-select" required>
                                        <option value="COMPANY">üè¢ C√¥ng ty</option>
                                        <option value="SENDER">üë§ Ng∆∞·ªùi g·ª≠i (ho√†n l·∫°i)</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">M√¥ t·∫£</label>
                                    <input type="text" name="description" class="form-control" placeholder="Ghi ch√∫">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                            <button type="submit" class="btn btn-success">T·∫°o Payment</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</body>

</html>